### Unit tests for consolidate.R functions

library(CNprep)
library(mclust)

### Tests consolidate() results

context("consolidate() results")

test_that("consolidate() must return expected results 01", {
    
    RNGkind("default")
    
    set.seed(112211)
    
    aaa <- c(0.07207384, 0.06363411, 0.08662475, 0.07319237, 0.06590141, 0.01463932, 0.07570822, 0.07893234)
    
    clusterModel <- Mclust(aaa, maxG=15, modelNames="E")
    
    results <- CNprep:::consolidate(clusterModel, 0.25)
    
    expected <- list()
    expected$mu <- c(0.0146393200001, 0.0737238628571)
    names(expected$mu) <- c(1, 2)
    expected$pro <- c(0.1250000000002, 0.8749999999998)
    expected$z <- matrix(c(2.529933e-17, 1.476860044e-12, 1.533442922e-25, 
                           5.90790486e-18, 7.743021831e-14, 1.000000000000000, 
                           0.000000000000000, 0.000000000000000, 1.00000e+00, 
                           0.999999999998523, 1.00000000e+00, 1.00000000e+00, 
                           0.999999999999923, 0.000000000000000, 1.00000000e+00, 
                           1.000000000000000),
                         byrow=FALSE, ncol=2, nrow = 8)
    attr(expected$z, "dim") <- c(8,2)
    attr(expected$z, "dimnames") <- list(NULL, NULL)
    expected$groups <- matrix(c(1.0000000000000, 0.0000000000000, 0.0000000000000, 1.0000000000000), ncol = 2, byrow = TRUE)
    expected$ngroups <- 2
    expected$sigmasq <- c(0.0000454372173, 0.0000454372173)
    
    expect_equal(results, expected)
})

test_that("consolidate() must return expected results 02", {
    
    RNGkind("default")
    
    set.seed(11211)
    
    aaa <- c(0.03207384, 0.0333411, 0.07662475, 0.08319237, 0.08590141, 0.034162232, 0.0700822, 0.07111234)
    
    clusterModel <- Mclust(aaa, maxG=15, modelNames="E")
    
    results <- CNprep:::consolidate(clusterModel, 0.20)
    
    expected <- list()
    expected$mu <- c(0.03319239066667, 0.07059726999996, 0.07662474998258, 0.08454689000000)
    names(expected$mu) <- c(1, 3, 4, 5)
    expected$pro <- c(0.37500000000000, 0.24999999963694, 0.12500000036342, 0.24999999999964)
    expected$z <- matrix(c(1.000000000000000, 1.000000000000000, 0.000000000000000, 
                           0.000000000000000, 0.000000000000000, 1.000000000000000, 
                           0.000000000000000, 0.000000000000000, 
                           0.000000000000000, 
                           0.000000000000000, 0.000000000263183, 0.000000000000000, 
                           0.000000000000000, 0.000000000000000, 1.000000000000000, 
                           0.999999996787130, 
                           0.000000000000000, 0.000000000000000, 
                           0.999999999736817, 0.000000000002931, 0.000000000000000,
                           0.000000000000000, 0.000000000001347, 0.000000003212870,
                           0.000000000000000, 0.000000000000000, 0.000000000000000,
                           0.999999999997069, 1.000000000000000, 0.000000000000000,
                           0.000000000000000, 0.000000000000000),
                         byrow=FALSE, ncol=4, nrow = 8)
    attr(expected$z, "dim") <- c(8,4)
    expected$groups <- matrix(c(1.0000000000000, 1.0000000000000, 0.0000000000000, 0.0000000000000, 0.0000000000000,
                                0.0000000000000, 0.0000000000000, 1.0000000000000, 0.0000000000000, 0.0000000000000,
                                0.0000000000000, 0.0000000000000, 0.0000000000000, 1.0000000000000, 0.0000000000000,
                                0.0000000000000, 0.0000000000000, 0.0000000000000, 0.0000000000000, 1.0000000000000), ncol = 5, byrow = TRUE)
    expected$ngroups <- 4
    expected$sigmasq <- c(0.00000080725757, 0.00000079842655, 0.00000079842655, 0.00000079842655)
    
    expect_equal(results, expected)
})